#!/usr/bin/env sh

set -e

CRONTAB_FILE="/var/spool/cron/crontabs/root"
JOBRUNNER_PATH="/usr/local/bin/jobrunner"


# This line mainly just to clear the crontab file contents if something is already written there
echo "# Crontab generated by entrypoint script on $(date)" > "$CRONTAB_FILE"

# Ensure the base periodic directory exists and clean its contents
# to prevent orphaned directories from previous configurations or
# if CRONTAB_ environment variable names change.
echo "INFO: Preparing /etc/periodic/ directory by cleaning its contents..."
mkdir -p /etc/periodic
find /etc/periodic/ -mindepth 1 -delete

# Iterate over all environment variables starting with CRONTAB_
env | grep '^CRONTAB_' | while IFS='=' read -r var_name var_value; do
    # Remove quotes if they have snuck in there
    cron_schedule=$(echo "$var_value" | sed "s/^'//; s/'$//; s/^\"//; s/\"$//")

    if [ -z "$cron_schedule" ]; then
        echo "INFO: Skipping $var_name because its value is empty. (As var_value: $var_value , as cron_schedule: $cron_schedule)"
        continue
    fi

    # Extract the periodicity name and convert to lowercase for directory name
    # (e.g., daily2 from CRONTAB_DAILY2)
    periodicity_dir_name=$(echo "$var_name" | sed 's/^CRONTAB_//' | tr '[:upper:]' '[:lower:]')

    if [ -z "$periodicity_dir_name" ]; then
        echo "WARNING: Could not extract periodicity tag from $var_name. Skipping."
        continue
    fi

    echo "INFO: Processing $var_name: schedule='$cron_schedule', periodicity_dir_name='$periodicity_dir_name'"

    periodic_dir_path="/etc/periodic/$periodicity_dir_name"
    mkdir -p "$periodic_dir_path"
    ln -sf "$JOBRUNNER_PATH" "$periodic_dir_path/jobrunner"
    echo "$cron_schedule run-parts $periodic_dir_path" >> "$CRONTAB_FILE"
    echo "INFO: Added to crontab: $cron_schedule run-parts $periodic_dir_path"
done

echo "--- Generated crontab ($CRONTAB_FILE) ---"
cat "$CRONTAB_FILE"
echo "--- End of crontab ---"

# Install selected postgres-client if needed
if [ -n "$PGHOST" ]; then
    ORIG_PWD=$(pwd)
    cd "$APK_POSTGRES_DIR/$DB_VERSION"
    apk add *.apk
    cd $ORIG_PWD
    # Smoke test
    psql --version && pg_dump --version
fi

# Continue work
exec "$@"
